stages:
  - package
  - deploy

package:
  image: debian:stretch
  stage: package
  before_script:
    - apt-get update
    - apt-get install python3-pip virtualenv ruby ruby-dev rubygems build-essential -y
    - gem install --no-ri --no-rdoc fpm
  script:
    - pip3 install .
    - fpm --verbose -s virtualenv -t deb -a all --python-pip /usr/bin/pip3 --python-bin /usr/bin/python3 --deb-systemd "prometheus-junos-exporter.service" prometheus-junos-exporter
  artifacts:
    paths:
      - "*.deb"
  allow_failure: false

release_package:
  image: debian:stretch
  stage: deploy
  dependencies:
    - package
  before_script:
    - dpkg -c prometheus-junos-exporter*.deb
    - apt-get update
    - apt-get install -y python3-requests wget
    - wget https://$PACKAGE_FACTORY/aptly.py
  script:
    - export FILENAME=$(ls prometheus-*-exporter*.deb)
    - python3 aptly.py -a https://$PACKAGE_FACTORY/api -f $CI_PROJECT_NAME -r selfnet-prometheus -u $APTLYUSER -p $APTLYPASSWORD -g $SIGN_PASSPHRASE $FILENAME
  only:
    - master
  allow_failure: false

